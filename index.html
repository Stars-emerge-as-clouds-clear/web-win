<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>人机验证</title>
<style>
  body {
    font-family: 'Arial', sans-serif;
    background-color: #f7f7f7;
    color: #333;
    text-align: center;
    padding-top: 50px;
  }
  .container {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: inline-block;
    margin: 0 auto;
  }
  .container h2 {
    margin-bottom: 20px;
  }
  .captcha-image {
    margin-bottom: 10px;
    position: relative;
    display: inline-block;
    cursor: pointer;
  }
  .captcha-image img {
    display: block;
  }
  .captcha-image::after {
    content: '换一个';
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: rgba(0, 0, 0, 0.5);
    color: white;
    padding: 5px;
    border-radius: 3px;
    font-size: 12px;
    visibility: hidden;
  }
  .captcha-image:hover::after {
    visibility: visible;
  }
  input[type="text"] {
    padding: 10px;
    margin-right: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  button {
    padding: 10px 20px;
    background-color: #5cb85c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #4cae4c;
  }
</style>
<script>
// 函数：将非HTTPS协议转换为HTTPS协议
function convertToHttps(url) {
    return url.replace(/^http:/, 'https:');
}

// 函数：设置Cookies
function setCookie(name, value, expirationSeconds) {
    var d = new Date();
    d.setTime(d.getTime() + expirationSeconds * 1000);
    var expires = "expires=" + d.toUTCString();
    document.cookie = name + "=" + value + ";" + expires + ";path=/";
}

// 函数：获取Cookies
function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

// 函数：生成六位数字加小写字母的验证码
function generateCaptcha() {
    var captcha = '';
    var chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    for (var i = 0; i < 6; i++) {
        captcha += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return captcha;
}

// 函数：生成简单的验证码图片
function generateCaptchaImage() {
    var canvas = document.createElement('canvas');
    var width = 150;
    var height = 40;
    canvas.width = width;
    canvas.height = height;
    var ctx = canvas.getContext('2d');
    ctx.strokeStyle = '#cccccc';
    for (var i = 0; i < 5; i++) {
        ctx.beginPath();
        ctx.moveTo(Math.random() * width, Math.random() * height);
        ctx.lineTo(Math.random() * width, Math.random() * height);
        ctx.stroke();
    }
    for (var i = 0; i < 100; i++) {
        ctx.beginPath();
        ctx.arc(Math.random() * width, Math.random() * height, 1, 0, Math.PI * 2);
        ctx.fillStyle = '#cccccc';
        ctx.fill();
    }
    var captcha = generateCaptcha();
    setCookie('captcha', captcha, 20);
    ctx.font = '20px Arial';
    ctx.fillStyle = 'black';
    var textWidth = ctx.measureText(captcha).width;
    ctx.translate(width / 2, height / 2);
    var rotation = Math.random() * (Math.PI / 4) - (Math.PI / 8);
    ctx.rotate(rotation);
    ctx.fillText(captcha, -textWidth / 2, 0);
    return canvas.toDataURL('image/png');
}

// 函数：验证验证码
function verifyCaptcha() {
    var userCaptcha = document.getElementById('captchaInput').value;
    var correctCaptcha = getCookie('captcha');
    if(userCaptcha === correctCaptcha) {
        window.location.href = 'main.html';
    } else {
        alert('验证码错误，请重试。');
    }
}

// 函数：刷新验证码
function refreshCaptcha() {
    var attempts = getCookie('attempts');
    if (attempts) {
        attempts = parseInt(attempts, 10) + 1;
    } else {
        attempts = 1;
    }
    if (attempts > 5) {
        alert('十分钟内只能刷新五次验证码，请稍后再试。');
        return;
    }
    setCookie('attempts', attempts, 600); // 10 minutes in seconds
    var captchaImage = document.getElementById('captchaImage');
    captchaImage.src = generateCaptchaImage();
    setCookie('captcha', '', -1); // Clear the old captcha
}

// 页面加载时执行
window.onload = function() {
    var links = document.getElementsByTagName('a');
    for (var i = 0; i < links.length; i++) {
        links[i].href = convertToHttps(links[i].href);
    }
    var captchaImageSrc = generateCaptchaImage();
    document.getElementById('captchaImage').src = captchaImageSrc;
};
</script>
</head>
<body>
<div class="container">
  <h2>人机验证</h2>
  <p>请输入验证码：
    <div class="captcha-image" onclick="refreshCaptcha()">
      <img id="captchaImage" src="" alt="验证码">
    </div>
    <input type="text" id="captchaInput" placeholder="验证码">
    <button onclick="verifyCaptcha()">提交</button>
  </p>
</div>
</body>
</html>
