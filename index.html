<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>重定向到HTTPS并带有反爬虫和验证码</title>
<script>
// 函数：将非HTTPS协议转换为HTTPS协议
function convertToHttps(url) {
    return url.replace(/^http:/, 'https:');
}

// 函数：设置Cookies
function setCookie(name, value, expirationSeconds) {
    var d = new Date();
    d.setTime(d.getTime() + expirationSeconds * 1000);
    var expires = "expires=" + d.toUTCString();
    document.cookie = name + "=" + value + ";" + expires + ";path=/";
}

// 函数：获取Cookies
function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

// 当前时间的哈希值
function generateHash() {
    var now = new Date();
    var hash = now.getFullYear() + 
              (now.getMonth() + 1).toString().padStart(2, '0') + 
              now.getDate().toString().padStart(2, '0') + 
              now.getHours().toString().padStart(2, '0') + 
              now.getMinutes().toString().padStart(2, '0');
    return hash;
}

// 函数：检测是否为爬虫
function isCrawler(userAgent) {
    var crawlers = /bot|crawl|spider|slurp|googlebot|bingbot|yandexbot/i;
    return crawlers.test(userAgent);
}

// 函数：生成简单的验证码图片
function generateCaptchaImage() {
    var canvas = document.createElement('canvas');
    var width = 120;
    var height = 40;
    canvas.width = width;
    canvas.height = height;
    var ctx = canvas.getContext('2d');

    // 绘制干扰线
    ctx.strokeStyle = '#cccccc';
    for (var i = 0; i < 5; i++) {
        ctx.beginPath();
        ctx.moveTo(Math.random() * width, Math.random() * height);
        ctx.lineTo(Math.random() * width, Math.random() * height);
        ctx.stroke();
    }

    // 绘制噪点
    for (var i = 0; i < 100; i++) {
        ctx.beginPath();
        ctx.arc(Math.random() * width, Math.random() * height, 1, 0, Math.PI * 2);
        ctx.fillStyle = '#cccccc';
        ctx.fill();
    }

    // 生成验证码文本
    var captcha = Math.random().toString(36).substring(2, 6);
    setCookie('captcha', captcha, 20);
    ctx.font = '20px Arial';
    ctx.fillStyle = 'black';
    var textWidth = ctx.measureText(captcha).width;
    ctx.translate(width / 2, height / 2);
    var rotation = Math.random() * (Math.PI / 4) - (Math.PI / 8); // 随机旋转文本，限制在正负40度以内
    ctx.rotate(rotation);
    ctx.fillText(captcha, -textWidth / 2, 0);

    return canvas.toDataURL('image/png');
}

// 函数：验证验证码
function verifyCaptcha() {
    var userCaptcha = document.getElementById('captchaInput').value;
    var correctCaptcha = getCookie('captcha');
    if(userCaptcha === correctCaptcha) {
        // 验证码正确，跳转到main.html
        window.location.href = 'main.html';
    } else {
        // 验证码错误，提示用户
        alert('验证码错误，请重试。');
    }
}

// 页面加载时执行
window.onload = function() {
    // 转换所有链接为HTTPS
    var links = document.getElementsByTagName('a');
    for (var i = 0; i < links.length; i++) {
        links[i].href = convertToHttps(links[i].href);
    }

    // 设置Cookies
    var hashValue = generateHash();
    setCookie('hash', hashValue, 20);

    // 检测是否为爬虫
    var userAgent = navigator.userAgent;
    if (isCrawler(userAgent)) {
        // 如果是爬虫，阻止页面加载
        document.body.innerHTML = "爬虫访问被拒绝。";
        return;
    }

    // 生成验证码图片并显示输入框
    var captchaImageSrc = generateCaptchaImage();
    document.body.innerHTML = '<p>请输入验证码：<img src="' + captchaImageSrc + '" alt="验证码"><input type="text" id="captchaInput"><button onclick="verifyCaptcha()">提交</button></p>';
};
</script>
</head>
<body>
重定向中...
</body>
</html>
